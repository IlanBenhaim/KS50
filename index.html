<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cagnotte Kamal & Sabry</title>
  <style>
    .cagnotte-counter {
      text-align: center;
      margin: 20px;
      font-family: Arial, sans-serif;
    }
    .progress-bar {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 20px;
      background-color: #4CAF50;
      width: 0%;
      transition: width 0.5s;
    }
    #loading-error button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="cagnotte-counter">
    <div id="totalAmountEUR">--- ‚Ç¨</div>
    <div id="totalAmountMAD">--- MAD</div>
    <div id="contributorCount">---</div>

    <div class="progress-bar">
      <div id="progressFillEUR" class="progress-fill"></div>
    </div>
    <div class="progress-bar">
      <div id="progressFillMAD" class="progress-fill"></div>
    </div>
  </div>

  <script>
    // Config
    const OBJECTIVE_EUR = 7000;
    const OBJECTIVE_MAD = 70000;
    const COUNTER_API_URL = "https://script.google.com/macros/s/AKfycbwPcoIxtN1EC8JYrU8Ka8z79bcz83xy1fhyTOxrZC-lYfO0L87_PzTd2vEhsD0Kaa80Bw/exec";

    async function fetchCagnotteData() {
      try {
        const response = await fetch(`${COUNTER_API_URL}?_t=${Date.now()}`, {
          headers: { "Accept": "application/json" },
          cache: "no-cache"
        });
        if (!response.ok) throw new Error(`Erreur r√©seau: ${response.status}`);

        const data = await response.json();
        if (data.error) throw new Error(data.message || "Erreur API");

        updateCagnotteDisplay(data.totalEUR, data.totalMAD, data.contributorCount);
        showLastUpdateTime(data.lastUpdate);

      } catch (err) {
        showLoadingError(err.message);
        console.error("Erreur:", err);
      }
    }

    function updateCagnotteDisplay(totalEUR, totalMAD, contributors) {
      const errorDiv = document.getElementById("loading-error");
      if (errorDiv) errorDiv.remove();

      document.getElementById("totalAmountEUR").textContent = `${Math.round(totalEUR)} ‚Ç¨`;
      document.getElementById("totalAmountMAD").textContent = `${Math.round(totalMAD)} MAD`;
      document.getElementById("contributorCount").textContent = `${contributors} contributeurs`;

      const percentEUR = Math.min((totalEUR / OBJECTIVE_EUR) * 100, 100);
      document.getElementById("progressFillEUR").style.width = `${Math.round(percentEUR)}%`;

      const percentMAD = Math.min((totalMAD / OBJECTIVE_MAD) * 100, 100);
      document.getElementById("progressFillMAD").style.width = `${Math.round(percentMAD)}%`;
    }

    function showLastUpdateTime(lastUpdate) {
      const date = new Date(lastUpdate);
      let updateDiv = document.getElementById("last-update-time");
      if (!updateDiv) {
        updateDiv = document.createElement("div");
        updateDiv.id = "last-update-time";
        updateDiv.style.cssText = "font-size:0.8rem;opacity:0.7;margin-top:10px;text-align:center;";
        document.querySelector(".cagnotte-counter").appendChild(updateDiv);
      }
      updateDiv.textContent = `Derni√®re actualisation: ${date.toLocaleString("fr-FR")}`;
    }

    function showLoadingError(msg) {
      document.getElementById("totalAmountEUR").textContent = "--- ‚Ç¨";
      document.getElementById("totalAmountMAD").textContent = "--- MAD";
      document.getElementById("contributorCount").textContent = "---";

      let errorDiv = document.getElementById("loading-error");
      if (!errorDiv) {
        errorDiv = document.createElement("div");
        errorDiv.id = "loading-error";
        errorDiv.style.cssText = "background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);color:#c0392b;padding:10px;border-radius:6px;margin-top:15px;font-size:0.9rem;text-align:center;";
        document.querySelector(".cagnotte-counter").appendChild(errorDiv);
      }
      errorDiv.innerHTML = `
        ‚ö†Ô∏è Impossible de charger les donn√©es<br>
        <small style="opacity:0.8;">Erreur: ${msg}</small><br>
        <button onclick="fetchCagnotteData()" style="margin-top:8px;padding:5px 10px;background:#c0392b;color:white;border:none;border-radius:4px;">üîÑ R√©essayer</button>
      `;
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchCagnotteData();
      setInterval(fetchCagnotteData, 120000);
    });
  </script>
</body>
</html>